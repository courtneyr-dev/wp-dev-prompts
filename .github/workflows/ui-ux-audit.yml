# UI/UX Audit Workflow
#
# Runs UI/UX tests on pull requests that modify frontend code.
# Includes visual hierarchy, navigation, responsive, accessibility, and heuristic tests.

name: UI/UX Audit

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'styles/**'
      - 'components/**'
      - 'ui/**'
      - 'tests/ui-ux/**'
      - '.github/workflows/ui-ux-audit.yml'
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Base URL to test (leave empty for localhost)'
        required: false
        default: ''

concurrency:
  group: ui-ux-${{ github.ref }}
  cancel-in-progress: true

env:
  BASE_URL: ${{ github.event.inputs.base_url || 'http://localhost:3000' }}

jobs:
  # ============================================================================
  # PLAYWRIGHT UI/UX TESTS
  # ============================================================================
  ui-ux-tests:
    name: UI/UX Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium firefox

      - name: Start development server
        run: |
          npm run dev &
          sleep 10
          curl -s ${{ env.BASE_URL }} > /dev/null || echo "Server may not be running"
        continue-on-error: true

      - name: Run Visual Hierarchy Tests
        run: npx playwright test tests/ui-ux/visual-hierarchy.spec.ts --reporter=list
        continue-on-error: true

      - name: Run Navigation Tests
        run: npx playwright test tests/ui-ux/navigation.spec.ts --reporter=list
        continue-on-error: true

      - name: Run Responsive Tests
        run: npx playwright test tests/ui-ux/responsive.spec.ts --reporter=list
        continue-on-error: true

      - name: Run Feedback & Affordance Tests
        run: npx playwright test tests/ui-ux/feedback-affordance.spec.ts --reporter=list
        continue-on-error: true

      - name: Run Accessibility Tests
        run: npx playwright test tests/ui-ux/accessibility.spec.ts --reporter=list
        continue-on-error: true

      - name: Run Heuristic Evaluation Tests
        run: npx playwright test tests/ui-ux/heuristic-evaluation.spec.ts --reporter=list
        continue-on-error: true

      - name: Generate HTML Report
        if: always()
        run: npx playwright test --reporter=html 2>/dev/null || true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-ux-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 14

      - name: Upload Visual Snapshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-snapshots
          path: tests/ui-ux/__snapshots__/
          retention-days: 14

  # ============================================================================
  # STORYBOOK VISUAL REGRESSION
  # ============================================================================
  storybook-visual:
    name: Storybook Visual Regression
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Storybook
        run: |
          cd ui/storybook
          npm ci 2>/dev/null || npm install
          npm run build-storybook 2>/dev/null || npx storybook build
        continue-on-error: true

      - name: Run Storybook Tests
        run: |
          cd ui/storybook
          npx concurrently -k -s first -n "SB,TEST" \
            "npx http-server storybook-static --port 6006 --silent" \
            "npx wait-on tcp:6006 && npx test-storybook"
        continue-on-error: true

      - name: Upload Storybook Build
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: storybook-build
          path: ui/storybook/storybook-static/
          retention-days: 7

  # ============================================================================
  # ACCESSIBILITY AUDIT
  # ============================================================================
  accessibility-audit:
    name: Accessibility Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install axe-core CLI
        run: npm install -g @axe-core/cli

      - name: Start development server
        run: |
          npm run dev &
          sleep 10
        continue-on-error: true

      - name: Run axe accessibility audit
        run: |
          axe ${{ env.BASE_URL }} \
            --save axe-results.json \
            --tags wcag2a,wcag2aa,best-practice \
            --exit
        continue-on-error: true

      - name: Upload Accessibility Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-results
          path: axe-results.json
          retention-days: 14

  # ============================================================================
  # RESPONSIVE SCREENSHOTS
  # ============================================================================
  responsive-screenshots:
    name: Responsive Screenshots
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install chromium

      - name: Start development server
        run: |
          npm run dev &
          sleep 10
        continue-on-error: true

      - name: Capture Responsive Screenshots
        run: |
          mkdir -p screenshots

          # Create screenshot script
          cat > take-screenshots.js << 'EOF'
          const { chromium } = require('playwright');

          const viewports = [
            { name: 'mobile-320', width: 320, height: 568 },
            { name: 'mobile-375', width: 375, height: 667 },
            { name: 'tablet-768', width: 768, height: 1024 },
            { name: 'desktop-1280', width: 1280, height: 800 },
            { name: 'wide-1920', width: 1920, height: 1080 },
          ];

          const pages = ['/', '/about', '/contact'];

          (async () => {
            const browser = await chromium.launch();

            for (const vp of viewports) {
              const context = await browser.newContext({
                viewport: { width: vp.width, height: vp.height }
              });
              const page = await context.newPage();

              for (const path of pages) {
                try {
                  await page.goto(process.env.BASE_URL + path, { timeout: 10000 });
                  await page.waitForLoadState('networkidle', { timeout: 5000 }).catch(() => {});
                  const filename = `screenshots/${vp.name}${path.replace(/\//g, '-') || '-home'}.png`;
                  await page.screenshot({ path: filename, fullPage: true });
                  console.log(`Captured: ${filename}`);
                } catch (e) {
                  console.log(`Failed: ${vp.name}${path} - ${e.message}`);
                }
              }

              await context.close();
            }

            await browser.close();
          })();
          EOF

          node take-screenshots.js
        continue-on-error: true
        env:
          BASE_URL: ${{ env.BASE_URL }}

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: responsive-screenshots
          path: screenshots/
          retention-days: 14

  # ============================================================================
  # SUMMARY REPORT
  # ============================================================================
  summary:
    name: UI/UX Audit Summary
    runs-on: ubuntu-latest
    needs: [ui-ux-tests, storybook-visual, accessibility-audit, responsive-screenshots]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
        continue-on-error: true

      - name: Generate Summary
        run: |
          echo "## UI/UX Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| UI/UX Tests | ${{ needs.ui-ux-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Storybook Visual | ${{ needs.storybook-visual.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility | ${{ needs.accessibility-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Responsive Screenshots | ${{ needs.responsive-screenshots.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ui-ux-test-results**: Playwright test report" >> $GITHUB_STEP_SUMMARY
          echo "- **visual-snapshots**: Visual regression baselines" >> $GITHUB_STEP_SUMMARY
          echo "- **storybook-build**: Static Storybook site" >> $GITHUB_STEP_SUMMARY
          echo "- **accessibility-results**: axe-core audit JSON" >> $GITHUB_STEP_SUMMARY
          echo "- **responsive-screenshots**: Multi-viewport captures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [UI/UX Audit Guide](docs/ui-ux-audit.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [UI/UX Guidelines](docs/ui-ux-guidelines.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Audit Checklist](data/ui-ux-audit-checklist.yaml)" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## UI/UX Audit Complete

            | Suite | Status |
            |-------|--------|
            | UI/UX Tests | ${{ needs.ui-ux-tests.result }} |
            | Storybook | ${{ needs.storybook-visual.result }} |
            | Accessibility | ${{ needs.accessibility-audit.result }} |
            | Screenshots | ${{ needs.responsive-screenshots.result }} |

            ðŸ“¦ **Artifacts available in Actions tab**
            ðŸ“– **See [UI/UX Audit Guide](docs/ui-ux-audit.md) for details**
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
        continue-on-error: true
