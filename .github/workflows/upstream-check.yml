name: Check Upstream Dependencies

on:
  schedule:
    # Every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  check-upstreams:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check all upstream sources
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Run the sync script in check mode (covers all 11 sources + skills.sh sub-repos)
          set +e
          bash scripts/sync-upstream.sh --check > check-results.txt 2>&1
          EXIT_CODE=$?
          set -e

          cat check-results.txt

          if [[ $EXIT_CODE -eq 1 ]]; then
            echo "has_updates=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_updates=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create issue if updates available
        if: steps.check.outputs.has_updates == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY=$(cat <<'ISSUE_EOF'
          ## Upstream Dependency Updates

          ```
          ISSUE_EOF
          )
          BODY+=$'\n'
          BODY+=$(cat check-results.txt)
          BODY+=$'\n```\n\n'
          BODY+=$(cat <<'ISSUE_EOF'
          ## Next Steps

          1. Fetch updated source:
             ```bash
             bash scripts/sync-upstream.sh --fetch <owner/repo>
             ```
          2. Compare changes:
             ```bash
             bash scripts/sync-upstream.sh --diff <owner/repo>
             ```
          3. Apply relevant changes manually (content is adapted, not copied)
          4. Update sync date:
             ```bash
             bash scripts/sync-upstream.sh --update <owner/repo>
             ```

          See `UPSTREAM.md` for full integration notes and affected files.
          ISSUE_EOF
          )

          gh issue create \
            --title "Upstream updates available ($(date +%Y-%m-%d))" \
            --body "$BODY" \
            --label "dependencies,upstream"

      - name: Summary
        if: always()
        run: |
          echo "## Upstream Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat check-results.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
